<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="description" content="expert system plays tic tac toe.">
	<title>TTT</title>
	<link rel="stylesheet" href="/styles.css" />
</head>

<body>
	<h1 id="heading"></h1>
	<div class="grid" id="myGrid">
		<button id="cell-1"></button><button id="cell-2"></button><button id="cell-3"></button>
		<button id="cell-4"></button><button id="cell-5"></button><button id="cell-6"></button>
		<button id="cell-7"></button><button id="cell-8"></button><button id="cell-9"></button>
	</div>
	<button id="machineButton">Machine first</button>
	<button id="resetButton">Start again</button><br>
	<output id="outputId" for="myGrid"></output>

	<script>
		fetch('/message')
			.then((resp) => resp.text())
			.then((text) => {
				const h1 = document.getElementById('heading');
				h1.textContent = text;
			})
			.catch(error => console.error('fetch error:', error));

		const machineBtn = document.getElementById('machineButton')
		document.getElementById('myGrid').addEventListener('click', function (event) {
			console.debug('click:', event.target)
			// Check if the element clicked (event.target) is a <button> element
			if (event.target.nodeName === 'BUTTON') {
				machineBtn.disabled = true
				const tdId = event.target.id;
				const cell = document.getElementById(tdId);
				if (cell.textContent !== '') {
					// Cell is already filled, do nothing
					return;
				}
				console.debug(`You clicked on cell with ID: ${tdId}`)
				cell.textContent = 'X'; // Change the content of the clicked cell to 'X'
				let str = ''
				for (let i = 1; i <= 9; i++) {
					const el = document.getElementById('cell-' + i)
					const ch = el.textContent
					str += ch === '' ? '-' : ch
				}
				const output = document.getElementById('outputId');
				output.textContent = `"${str}"`
				fetch('/play', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ oldState: str })
				}).then(resp => resp.json())
					.then(text => console.debug('POST /play text: ', text))
					.catch(err => console.error('POST /play err: ', err));
			}
		});

		machineBtn.addEventListener('click', async function () {
			const str = '---------'
			fetch('/play', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ oldState: str })
			}).then(resp => resp.json())
				.then(text => console.debug('POST /play text: ', text))
				.catch(err => console.error('POST /play err: ', err));
			this.disabled = true
		});

		document.getElementById('resetButton').addEventListener('click', function () {
			for (let i = 1; i <= 9; i++) {
				const el = document.getElementById('cell-' + i)
				el.textContent = ''
			}
			const output = document.getElementById('outputId');
			output.textContent = ''
			machineBtn.disabled = false
		});
	</script>
</body>

</html>